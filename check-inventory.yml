---
 - name: Check host age with VMware inventory source
   become: false
   hosts: localhost
   gather_facts: false

   vars:
      stage_inventory:
      staged_host:

   tasks:
     - name: Gather host info from stage inventory
       uri:
          url: https://student1.7phbk.example.opentlc.com/api/v2/inventories/2/hosts/
          method: GET
          user: "{{ controller_username }}"
          password: "{{ controller_password }}"
          force_basic_auth: yes
          validate_certs: false
          body_format: json
       register: stage_inventory_info

     - name: Print each host and the date they were added to the inventory
       debug:
          msg: "{{ stage_inventory_info.json.results | json_query(jmesquery) }}"
       vars:
          jmesquery: "[*].{Name: name, Created: created}"
       register: jmesquery

     - name: Determine age of each vm
       set_fact:
          secsdiff: '{{ ( (item.created | to_datetime) - (ansible_date_time.iso8601 | to_datetime) ).total_seconds() }}'
         # host_data: {{ item.created | combine({ "age": "blah" }) }}"
       with_items: stage_inventory_info.json.results
       register: age

    - name: print age
      debug: 
         msg: "{{ age }}"


       
