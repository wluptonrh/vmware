---
 - name: Decommission VM on vCenter
   become: false
   hosts: localhost
   gather_facts: true

   vars:
     decom_vm: rhel86-tpl
     staging_folder: /SDDC-Datacenter/vm/Workloads
     

   tasks: 

     - name: Get Tags from given VM Name
       block:
        - name: Get virtual machine info
          community.vmware.vmware_vm_info:
            hostname: '{{ vcenter_hostname }}'
            username: '{{ vcenter_username }}'
            password: '{{ vcenter_password }}'
            folder: '{{ staging_folder }}'
          delegate_to: localhost
          register: vm_info

        - debug:
            msg: "{{ item.tags }}"
          with_items:
            - "{{ vm_info.virtual_machines | community.general.json_query(query) }}"
          vars:
            query: "[?guest_name=={{ decom_vm }}]"


